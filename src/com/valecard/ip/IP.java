package com.valecard.ip;

import java.io.ByteArrayOutputStream;
import java.io.DataInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.PrintStream;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.Properties;

import org.jpos.iso.AsciiHexInterpreter;
import org.jpos.iso.EbcdicBinaryInterpreter;
import org.jpos.iso.ISOMsg;
import org.jpos.iso.ISOPackager;
import org.jpos.iso.packager.GenericPackager;

public class IP {
	
	Properties props;
	String dbDriver;
	String dbUrl;
	String dbUser;
	String dbPasswd;
	Boolean generateLogs;
	String outgoingFilesPath;
	Connection connection;
	long lineNumber;
	
	
	String InsertOutgoingMasterSQL = "insert into  TAB_OUTGOING_MASTER "
			+ "(NRO_LINHA, MTI, VALOR, DATAHORA, POINT_OF_SERVICE_DATA_CODE_22, FUNCTION_CODE_24, MESSAGE_REASON_CODE_25, "
			+ "APPROVAL_CODE_38, CARD_ACCEPTOR_TERM_IDENTI_41,CARD_ACCEPTOR_IDENTI_CODE_42, INTERCHANGE_RATE_DESIGNATOR, NSU_TRANSACAO) "
			+ "values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
	
	public IP(Properties props) throws Exception {
		this.props = props;
		initProperties();
	}
	
	void initProperties() throws Exception {
		dbDriver = props.getProperty("dbDriver");
		dbUrl = props.getProperty("dbUrl");
		dbUser = props.getProperty("dbUser");
		dbPasswd = props.getProperty("dbPasswd");
		String generateLogsStr = props.getProperty("generateLogs", "false");
		generateLogs = Boolean.parseBoolean(generateLogsStr);
		
		outgoingFilesPath = props.getProperty("outgoingFilesPath");
	}
	
	protected void connectToDatabase() throws Exception {
		Class.forName(dbDriver);
		connection = DriverManager.getConnection(dbUrl, dbUser, dbPasswd);
	}
	
	protected void disconnectFromDatabase() throws Exception {
		connection.close();
	}
	
	public void testConnection() throws Exception {
		Statement stmt = connection.createStatement();
		ResultSet rs = stmt.executeQuery("select NRO_LINHA from TAB_OUTGOING_MASTER");
		Boolean flag = false;
		while (rs.next()) {
			String nroLinha = rs.getString("NRO_LINHA");
			System.out.println("NroLinha = " + nroLinha);
			flag = true;
		}
		
		if (!flag) {
			System.out.println("Nao ha dados");
		}
	}

	public static void printBytesInHex(String msg, byte[] data) {
		StringBuilder hexBuilder = new StringBuilder();
		for (int i=0; i<data.length; i++) {
			hexBuilder.append(String.format("%02X", data[i]));
		}
		System.out.println(msg + ": [" +hexBuilder.toString() + "]");
	}

	public static void printBytesInHex(byte[] data) {
		printBytesInHex("Bytes", data);
	}
	
	public static void readRawFile(String filename) throws Exception {
		File f = new File(filename);
		FileInputStream fis = new FileInputStream(f);
		DataInputStream dis = new DataInputStream(fis);
		
		byte[] rawEbcdicData = new byte[(int)f.length()];
		dis.read(rawEbcdicData);
		dis.close();
		EbcdicBinaryInterpreter ehi = new EbcdicBinaryInterpreter();
		byte[] asciiData = ehi.uninterpret(rawEbcdicData, 0, rawEbcdicData.length);
		
		System.out.print("EBCDIC:    [");
		StringBuilder hexBuilder = new StringBuilder();
		for (int i=0; i<asciiData.length; i++) {
			hexBuilder.append(String.format("%02X", asciiData[i]));
			System.out.print(String.format("%02X", rawEbcdicData[i]));
		}
		System.out.println();
		System.out.println("HEX ASCII: [" + hexBuilder.toString() + "]");
		System.out.println("STR ASCII: [" + new String(asciiData) + "]");
		
		FileOutputStream out = new FileOutputStream(new File("D:\\\\Work\\\\Valecard\\\\IP\\ascii2.dat"));
		out.write(asciiData);
		out.flush();
		out.close();
	}
	
	public static void printFileDataAsHex(String filename) throws Exception {
		File f = new File(filename);
		FileInputStream fis = new FileInputStream(f);
		DataInputStream dis = new DataInputStream(fis);
		
		byte[] rawData = new byte[(int)f.length()];
		dis.read(rawData);
		dis.close();

		printBytesInHex(rawData);
	}

	
	static public String [] isoData = {
			"F1F6F4F480000100000100000200000000000000F6F9F7F0F4F0F0F1F0F5F0F2F5F0F0F2F2F1F0F3F1F2F0F0F0F0F0F0F3F0F8F2F7F0F0F0F0F1F0F1F2F2F0F0F1E3F0F0F0F0F0F0F0F1",
			"F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F6F2F0F1F7F2F5F1F2F0F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F1F2F3F8F6F0F3F1F0F2F9F5F1F1F0F0F0F0F0F0F3F0F8F2F7F2F0F4F7F9F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F6F7F6F7F5F4F1F64040F5F4F2C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F7F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8D6F1D7C6F0F3F1F14040F0F0F0F0F0F0F0F2F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7",
			"F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F6F1F9F5F8F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F0F8F3F4F5F0F2F4F0F7F1F8F1F1F0F0F0F0F0F0F3F0F8F2F7F1F3F6F9F8F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F2F5F4F1F6F6F1F74040F4F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F4F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8D2F3D7C6F0F3F1F14040F0F0F0F0F0F0F0F3F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7",
			"F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F5F3F4F4F6F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F0F8F0F2F9F0F2F8F9F6F8F1F1F1F0F0F0F0F0F0F3F0F8F2F7F4F2F8F2F5F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F0F5F4F1F6F0F1F04040F0F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F2F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C4F2D7C5D7C6F0F3F1F14040F0F0F0F0F0F0F0F4F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7",
			"F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F5F3F5F5F1F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F2F9F2F6F4F0F0F9F0F7F0F7F1F1F0F0F0F0F0F0F3F0F8F2F7F3F3F7F1F5F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F2F5F4F1F6F6F1F74040F4F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F4F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C4F2F4C1D7C6F0F3F1F14040F0F0F0F0F0F0F0F5F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7",
			"F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F5F3F6F3F5F2F5F1F2F0F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F2F7F0F7F3F0F2F5F4F6F4F9F1F1F0F0F0F0F0F0F3F0F8F2F7F1F0F2F4F0F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F6F7F6F7F5F4F1F64040F5F4F2C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F7F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C4F3C5D8D7C6F0F3F1F14040F0F0F0F0F0F0F0F6F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7",
			"F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F6F0F0F2F1F0F3F1F1F1F6F1F9F2F6F2F5F1F2F0F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F1F7F2F0F3F0F2F5F7F4F4F9F1F1F0F0F0F0F0F0F3F0F8F2F7F9F2F2F3F9F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F6F7F6F7F5F4F1F64040F5F4F2C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F7F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8C5D5D7C6F0F3F1F14040F0F0F0F0F0F0F0F7F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7",
			"F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F6F1F9F4F2F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F0F2F3F6F3F0F2F5F0F0F1F3F1F1F0F0F0F0F0F0F3F0F8F2F7F9F1F0F0F4F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F0F5F4F1F6F0F1F04040F0F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F2F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8C8D9D7C6F0F3F1F14040F0F0F0F0F0F0F0F8F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7",
			"F1F6F4F480000100000100000200000000000000F6F9F5F0F7F0F0F1F0F5F0F2F5F0F0F2F2F1F0F3F1F2F0F0F0F0F0F0F3F0F8F2F7F0F0F0F0F1F0F3F0F1F0F1F6F0F0F0F0F0F0F0F0F0F0F0F0F4F8F0F0F0F3F0F6F0F0F8F0F0F0F0F0F0F0F9F0F0F0F0F0F0F0F9"
	};
	static public String fullIsoData = "F1F6F4F480000100000100000200000000000000F6F9F7F0F4F0F0F1F0F5F0F2F5F0F0F2F2F1F0F3F1F2F0F0F0F0F0F0F3F0F8F2F7F0F0F0F0F1F0F1F2F2F0F0F1E3F0F0F0F0F0F0F0F1F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F6F2F0F1F7F2F5F1F2F0F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F1F2F3F8F6F0F3F1F0F2F9F5F1F1F0F0F0F0F0F0F3F0F8F2F7F2F0F4F7F9F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F6F7F6F7F5F4F1F64040F5F4F2C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F7F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8D6F1D7C6F0F3F1F14040F0F0F0F0F0F0F0F2F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F6F1F9F5F8F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F0F8F3F4F5F0F2F4F0F7F1F8F1F1F0F0F0F0F0F0F3F0F8F2F7F1F3F6F9F8F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F2F5F4F1F6F6F1F74040F4F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F4F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8D2F3D7C6F0F3F1F14040F0F0F0F0F0F0F0F3F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F5F3F4F4F6F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F0F8F0F2F9F0F2F8F9F6F8F1F1F1F0F0F0F0F0F0F3F0F8F2F7F4F2F8F2F5F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F0F5F4F1F6F0F1F04040F0F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F2F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C4F2D7C5D7C6F0F3F1F14040F0F0F0F0F0F0F0F4F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F5F3F5F5F1F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F2F9F2F6F4F0F0F9F0F7F0F7F1F1F0F0F0F0F0F0F3F0F8F2F7F3F3F7F1F5F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F2F5F4F1F6F6F1F74040F4F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F4F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C4F2F4C1D7C6F0F3F1F14040F0F0F0F0F0F0F0F5F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F5F3F6F3F5F2F5F1F2F0F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F2F7F0F7F3F0F2F5F4F6F4F9F1F1F0F0F0F0F0F0F3F0F8F2F7F1F0F2F4F0F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F6F7F6F7F5F4F1F64040F5F4F2C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F7F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C4F3C5D8D7C6F0F3F1F14040F0F0F0F0F0F0F0F6F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F6F0F0F2F1F0F3F1F1F1F6F1F9F2F6F2F5F1F2F0F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F1F7F2F0F3F0F2F5F7F4F4F9F1F1F0F0F0F0F0F0F3F0F8F2F7F9F2F2F3F9F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F6F7F6F7F5F4F1F64040F5F4F2C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F7F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8C5D5D7C6F0F3F1F14040F0F0F0F0F0F0F0F7F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7F1F2F4F0F01407C285E180020200000C00000000F1F6F5F2F0F4F7F4F0F0F0F0F0F0F1F0F0F2F0F0F0F0F0F0F0F0F0F0F0F0F0F0F0F7F0F0F2F1F0F3F1F1F1F6F1F9F4F2F2F5F1F2C4F1F0F2F0F1C2F5F4F0F0F1F0F0F0F2F0F0F1F4F0F1F5F9F9F9F2F3F0F2F7F1F1F3F8F1F0F7F1F0F2F3F6F3F0F2F5F0F0F1F3F1F1F0F0F0F0F0F0F3F0F8F2F7F9F1F0F0F4F0F1F0F1C8D6D4D6D3F0F0F1F0F0F0F2F0F1F0F0F0F0F0F0F0F0F4F5F7E2E4D7C5D9D4C5D9C3C1C4D640E3C5D1D6E3C1D6E0D9E4C140E3D9C5E9C5C5E0C1D9C1C7E4C1D9C9E0F0F5F4F1F6F0F1F04040F0F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3C3E3F2F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040F7F3F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F0F7F6F0F7F3F6F7F0F0F0F1F1F7F0F3F7F5F0F1F9F0F0F0F0F0F9F9F9F6F7F5F0F2F9F8F6F8F4F0F9F8F6F0F1F640D4C3E2C5C8C8D9D7C6F0F3F1F14040F0F0F0F0F0F0F0F8F1F1F0F0F0F0F0F9F9F9F6F7F5F1F1F0F0F0F0F0F0F3F0F8F2F7F1F6F4F480000100000100000200000000000000F6F9F5F0F7F0F0F1F0F5F0F2F5F0F0F2F2F1F0F3F1F2F0F0F0F0F0F0F3F0F8F2F7F0F0F0F0F1F0F3F0F1F0F1F6F0F0F0F0F0F0F0F0F0F0F0F0F4F8F0F0F0F3F0F6F0F0F8F0F0F0F0F0F0F0F9F0F0F0F0F0F0F0F9";
	
	static public String isoTestData = "F1F2F4F0F01407C285E182020200000C00000000F1F6F5F4F7F4F0F8F0F3F1F7F8F7F6F1F4F0F0F0F0F0F0F0F0F0F0F0F0F0F0F8F6F3F6F5F2F3F0F9F2F0F0F7F1F6F4F4F2F9F0F3D4F1F0F1F0F1C3F1F3F0F0F1F0F0F0F2F0F0F1F4F0F1F5F5F4F1F2F3F0F2F7F1F1F3F8F3F2F6F3F0F9F3F0F0F1F7F0F0F0F2F3F1F1F0F0F0F0F0F0F3F0F8F2F7F4F1F0F7F3F2F2F0F1F0F1F0F1F3F0F6F2F0F0F0F2F0F1F0F0F0F0F0F4F4F1F7F5F7D7D6E2E3D640C4D640D4C5C9D6E0C1E540C9C4C5D3C6D6D5E2D640C3C1D9D5C5C9D9D6E0C3C1C3E4E0F7F5F8F1F3F0F0F04040F0F7F6C2D9C1F1F4F0F0F0F2F3F0F0F3D5C140F0F0F5F2F0F0F3F1F1F0F0F1F4F8F0F0F4F9F8F6F2F0F1F5F8F0F2F4D4C3C340404040404040C9C1F0F0F0F0F0F0F0F040404040F0F1F6F5F0F0F1D4F0F1F7F0F0F1F6F0F0F060F0F0F0F0F0F0F04040404040F0F2F2F0F0F1F4F2F4F7F9F9F8F4F3F0F0F0F1F6F8F0F3F7F5F0F1F9F0F0F0F0F0F0F0F4F3F7F2F0F2F9F8F6F9F8F6F9F8F6F1F0F8820239008407A0000000041010950500000480009A032309209C01005F2A0209869F02060000000863659F10120110A04003220000000000000000000000FF9F1A0200769F26089D95BC44D0C9782C9F2701809F3501229F3602001A9F3704703D38CC9F0306000000000000F0F1F640D4C3C2F4E3F0E4C4F2F0F9F2F04040F0F0F0F0F0F0F5F2F1F1F0F0F0F0F0F0F0F4F3F7F2F1F1F0F0F0F0F0F0F3F0F8F2F7";
	
	static public String temp = "80000100000100000200000000000000";
		
	public ISOMsg unpackISOSimple(byte[] isoBytes, int mapType) throws Exception {
		ISOPackager packager = new GenericPackager(ISO8583MessageMap.getISO8583MessageMap(mapType).getMap());
		ISOMsg requestMsg = new ISOMsg();
		requestMsg.setPackager(packager);
		requestMsg.unpack(isoBytes);
		return requestMsg;
	}
	
	public static void unpackISO(byte[] isoBytes, int mapType) throws Exception {
		ISOPackager packager = new GenericPackager(ISO8583MessageMap.getISO8583MessageMap(mapType).getMap());
		byte[] remainingIsoBytes;
		int numberOfISOFrameBytes = isoBytes.length;
		int numberOfConsumedBytes = 0;
		
		while (numberOfConsumedBytes < numberOfISOFrameBytes) {
			int numberOfRemainingBytes = numberOfISOFrameBytes - numberOfConsumedBytes;
			remainingIsoBytes = new byte[numberOfRemainingBytes];
			System.arraycopy(isoBytes, numberOfConsumedBytes, remainingIsoBytes, 0, numberOfRemainingBytes);
			ISOMsg requestMsg = new ISOMsg();
			requestMsg.setPackager(packager);
			numberOfConsumedBytes += requestMsg.unpack(remainingIsoBytes);
		
			requestMsg.dump(System.out, " ");
		}
		
	}
	
	public static void unpackISO(String isoData, int mapType) throws Exception {
		AsciiHexInterpreter aih = AsciiHexInterpreter.INSTANCE;
		byte[] isoBytes = aih.uninterpret(isoData.getBytes(), 0, isoData.length()/2);
		unpackISO(isoBytes, mapType);
	}
	
	public static void testEBCDICtoASCII(String dataStr) throws Exception {
		AsciiHexInterpreter aih = AsciiHexInterpreter.INSTANCE;
		byte[] data = aih.uninterpret(dataStr.getBytes(), 0, dataStr.length()/2);
		printBytesInHex(data);
		
		EbcdicBinaryInterpreter ehi = new EbcdicBinaryInterpreter();
		byte[] firstBytes = ehi.uninterpret(data, 0, data.length);
		printBytesInHex(firstBytes);
		
		byte[] secondBytes = new byte[firstBytes.length];
		ehi.interpret(firstBytes, secondBytes, 0);
		printBytesInHex(secondBytes);
		System.out.println("----------------------------------------------------");
		
	}

	public class ISOMessageData {
		public ISOMessageData() {
			consumedBytes = 0;
			isoData = new ByteArrayOutputStream();
		}
		public int consumedBytes;
		public ByteArrayOutputStream isoData;
	}
	
	public ISOMessageData getISOMessageBytes(byte[] rawData, int index) {
		ISOMessageData isoMsgData = new ISOMessageData();
		boolean hasData = true;
		int headerLen = 0;
		
		while (hasData) {
			int id = (rawData[index+2] & 0xFF);
			int len = (rawData[index] & 0xFF);
			len <<= 8;
			len |= (rawData[index+1] & 0xFF);
			//System.out.println("Tamanho do Frame todo, com header: " + len + " ID = " + id);
			index += 4;
			isoMsgData.isoData.write(rawData, index, len-4);
			index += (len-4);
			headerLen += 4;
			if (id == 0) break;		// Qdo tem somente 1 linha de registro
			else {	// Verifica se tem que processa a proxima linha
				if (rawData[index+2] == 0) hasData = false;
			}
			
		}
		isoMsgData.consumedBytes = isoMsgData.isoData.size() + headerLen;
		
		return isoMsgData;
	}
	
	public static SimpleDateFormat dateFormat = new SimpleDateFormat("yyMMddhhmmss");
	public static SimpleDateFormat dateFormatOut = new SimpleDateFormat("dd/MM/yy hh:mm:ss");
	public void parseIPMFile(String filename) throws Exception {
		File f = new File(filename);
		FileInputStream fis = new FileInputStream(f);
		DataInputStream dis = new DataInputStream(fis);
	
		
		// Arquivo de saída dos dados em CSV
		File csvFile = new File(f.getAbsolutePath() + ".OUT.CSV");
		
		// Arquivo de log
		File logFile = new File(f.getAbsolutePath() + ".OUT.LOG");
		PrintStream csvOut = null;
		PrintStream logOut = null;
		
		if (generateLogs) {
			csvOut = new PrintStream(csvFile);
			logOut = new PrintStream(logFile);
		}
		
		// Carrega os dados do arquivo
		byte[] rawEbcdicData = new byte[(int)f.length()];
		dis.read(rawEbcdicData);
		dis.close();
		
		System.out.println("Tratando arquivo [" + filename + "]");
		
		if (csvOut != null)
			csvOut.println("MTI,VALOR (4),DATAHORA (12),POINT OF SERVICE DATA CODE (22),FUNCTION CODE (24),MESSAGE REASON CODE (25),"
					+ "APPROVAL CODE (38),CARD ACCEPTOR TERMINAL IDENTIFICATION (41),CARD ACCEPTOR IDENTIFICATION CODE (42),"
					+ "INTERCHANGE RATE DESIGNATOR");

		PDSTagParser pdsParser = new PDSTagParser();
		int index = 0;
		int parsedMessages = 0;
		while (index < rawEbcdicData.length) {
			ISOMessageData isoData = getISOMessageBytes(rawEbcdicData, index);
			ISOMsg isoMsg = unpackISOSimple(isoData.isoData.toByteArray(), ISO8583MessageMap.EBCDIC_MAP);
			index += isoData.consumedBytes;
			parsedMessages++;
			if (logOut != null)
				isoMsg.dump(logOut, " ");
			
			if (isoMsg.getMTI().equals("1240")) {
				String IRD = "";
				if (isoMsg.hasField(48)) {
					String bit48 = isoMsg.getString(48);
					List<PDSTag> list = pdsParser.parse(bit48);
					for (PDSTag pds : list) {
						if (logOut != null)
							logOut.println("  " + pds.tag + " = " + pds.value);
						if (pds.tag.equals("0158")) {
							IRD = new String(pds.value.getBytes(), 10, 2);
						}
					}
				}
				Date date = dateFormat.parse(isoMsg.getString(12));
				StringBuffer buffer = new StringBuffer();
				buffer.append(isoMsg.getMTI()).append(",")
				.append(isoMsg.getString(4)).append(",")
				.append(dateFormatOut.format(date)).append(",")
				.append(isoMsg.getString(22)).append(",")
				.append(isoMsg.getString(24)).append(",")
				.append(isoMsg.getString(25)).append(",")
				.append(isoMsg.getString(38)).append(",")
				.append(isoMsg.getString(41)).append(",")
				.append(isoMsg.getString(42)).append(",")
				.append(IRD);
				
				PreparedStatement stmt = connection.prepareStatement(InsertOutgoingMasterSQL);
				stmt.setLong(1, lineNumber++);
				stmt.setString(2, isoMsg.getMTI());
				stmt.setString(3, isoMsg.getString(4));
				stmt.setString(4, dateFormatOut.format(date));
				stmt.setString(5, isoMsg.getString(22));
				stmt.setString(6, isoMsg.getString(24));
				stmt.setString(7, isoMsg.getString(25));
				stmt.setString(8, isoMsg.getString(38));
				stmt.setString(9, isoMsg.getString(41));
				stmt.setString(10,isoMsg.getString(42));
				stmt.setString(11,  IRD);
				stmt.setLong(12,  0L);
				stmt.executeUpdate();

				if (csvOut != null)
					csvOut.println(buffer.toString());
			}
			
		}
		System.out.println("Numero de mensagens tratadas: " + parsedMessages);
		
		if (generateLogs) {
			System.out.println("Arquivo CSV com campos: " + csvFile.getAbsolutePath());
			System.out.println("Arquivo de LOG do pocessamento: " + logFile.getAbsolutePath());
			csvOut.close();
			logOut.close();
		}
	}
	
	public void parseFiles() throws Exception {
		connectToDatabase();
		
		File bulkDir = new File(outgoingFilesPath);
		if (bulkDir.isDirectory()) {
			File [] files = bulkDir.listFiles();
			lineNumber = 1;
			for(File f : files) {
				try {
					parseIPMFile(f.getAbsolutePath());
				} catch (Exception e) {
					System.out.println("Deu pau no arquivo : [" + f.getAbsolutePath() + "] : " + e.getMessage());
				}
			}
		}
		disconnectFromDatabase();
		System.out.println("Total de linhas inseridas: " + (lineNumber-1));
	}
	
	public static void main(String[] args) throws Exception {
		Properties props = new Properties();
		
		props.load(new FileInputStream(args[0]));
		
		IP ip = new IP(props);
		ip.parseFiles();
		//ip.parseIPMFile("data/CSU_ACQ_MASTER_OUTGOING_CIC1_21092023.TXT");
/*		
		printFileDataAsHex("D:\\Work\\Valecard\\IP\\OUTGOING_FILES\\CSU_ACQ_MASTER_OUTGOING_CIC1_02022023_161414.TXT");
		
		File f = new File("D:\\Work\\Valecard\\IP\\CSU_ACQ_MASTER_OUTGOING_CIC1_02082023_160510.TXT");
		FileInputStream fis = new FileInputStream(f);
		DataInputStream dis = new DataInputStream(fis);
		
		BufferedReader reader = new BufferedReader(new InputStreamReader(dis));
		byte [] header = new byte[4];
		String line;
		ISOPackager packager = new GenericPackager(ISO8583MessageMap.getISO8583MessageMap(ISO8583MessageMap.EBCDIC_MAP).getMap());
		ISOMsg requestMsg;
		while ((line = reader.readLine()) != null ) {
			System.out.println("Numero de bytes lidos: " + line.length());
			System.out.println("Linha: [" + line + "]");
			byte [] data = line.getBytes();
			byte [] isoData = new byte[data.length - 4];
			System.arraycopy(data, 4, isoData, 0, isoData.length);
			
			if (data.length > 4) {
				requestMsg = new ISOMsg();
				requestMsg.setPackager(packager);
				
				requestMsg.unpack(isoData);
				
				
				ByteArrayOutputStream out = new ByteArrayOutputStream();
				requestMsg.dump(new PrintStream(out), " ");
				
				String result = out.toString();
				
				System.out.println(result);
			}
			
			*/
//			System.out.print("Bytes = " + String.format("%02X %02X %02X %02X", header[2], header[3], header[0], header[1]));
//			int len = (header[2] & 0xFF);
//			len <<= 8;
//			len |= (header[3] & 0xFF);
//			len <<= 8;
//			len |= (header[0] & 0xFF);
//			len <<= 8;
//			len |= (header[1] & 0xFF);
//			
//			System.out.println("\nTamanho da linha: " + len);
//			String line = 
//			byte data[] = new byte[len];
//			int n = dis.read(data);
//			System.out.println("Bytes lidos = " + n);
		/*
		}
		fis.close();
		*/
		
		
//		for (int i=0; i<isoData.length; i++) {
//			unpackISO(isoData[i]);
//		}
		
//		unpackISO(fullIsoData, ISO8583MessageMap.EBCDIC_MAP);
		
//		testEBCDICtoASCII(temp);
		
		/*
		File f = new File("D:\\Work\\Valecard\\IP\\VISA_MASTER_INCOMING_OUTGOING\\VISA_MASTER_INCOMING_OUTGOING\\CSU_ACQ_MASTER_OUTGOING_CIC3_01022023_005117.TXT");
		FileInputStream fis = new FileInputStream(f);
		
		BufferedReader reader = new BufferedReader(new InputStreamReader(fis));
		String line;
		int i=0;
		while ((line = reader.readLine()) != null) {
			byte[] lineBytes = line.getBytes();
			printBytesInHex("FullLine", lineBytes);
			
			byte[] isoBytes = new byte[line.length()-4];
			
			// Converte o bitmap de volta
			byte[] bitmapBytes = new byte[16];
			System.arraycopy(lineBytes, 8, bitmapBytes, 0, 16);
			EbcdicBinaryInterpreter ehi = new EbcdicBinaryInterpreter();
			byte[] bitmap = new byte[16];
			ehi.interpret(bitmapBytes, bitmap, 0);
			//printBytesInHex("Bitmap Lido", bitmapBytes);
			//printBytesInHex("Bitmap Convertido", bitmap);
			
			
			System.arraycopy(lineBytes, 4, isoBytes, 0, lineBytes.length-4);
			System.arraycopy(bitmap, 0, isoBytes, 4, 16);
			
			//printBytesInHex(isoBytes);
			//unpackISO(isoBytes, ISO8583MessageMap.ASCII_MAP);
			i++;
		}
		*/
	}

}
